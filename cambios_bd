-- 20240930 Se agregan tablas de solicitudes credito y solicitudes credito clientes
CREATE TABLE `solicitudes_credito` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `fecha_creacion` datetime DEFAULT NULL,
    `nombre` varchar(255) DEFAULT NULL,
    `persona_tipo_id` int(11) DEFAULT NULL,
    `identificacion_tipo_id` int(11) DEFAULT NULL,
    `documento_numero` varchar(55) DEFAULT NULL,
    `direccion` varchar(255) DEFAULT NULL,
    `telefono` varchar(55) DEFAULT NULL,
    `email` varchar(255) DEFAULT NULL,
    `celular` varchar(55) DEFAULT NULL,
    `representante_legal` varchar(255) DEFAULT NULL,
    `representante_legal_documento_numero` varchar(55) DEFAULT NULL,
    `email_factura_electronica` varchar(255) DEFAULT NULL,
    `tesoreria_nombre` varchar(255) DEFAULT NULL,
    `tesoreria_email` varchar(255) DEFAULT NULL,
    `tesoreria_telefono` varchar(55) DEFAULT NULL,
    `tesoreria_celular` varchar(55) DEFAULT NULL,
    `comercial_nombre` varchar(55) DEFAULT NULL,
    `comercial_email` varchar(255) DEFAULT NULL,
    `comercial_telefono` varchar(55) DEFAULT NULL,
    `comercial_celular` varchar(55) DEFAULT NULL,
    `contabilidad_nombre` varchar(255) DEFAULT NULL,
    `contabilidad_email` varchar(255) DEFAULT NULL,
    `contabilidad_telefono` varchar(55) DEFAULT NULL,
    `contabilidad_celular` varchar(55) DEFAULT NULL,
    `referencia_comercial_entidad1` varchar(255) DEFAULT NULL,
    `referencia_comercial_cel1` varchar(55) DEFAULT NULL,
    `referencia_comercial_direccion1` varchar(255) DEFAULT NULL,
    `referencia_comercial_entidad2` varchar(255) DEFAULT NULL,
    `referencia_comercial_cel2` varchar(55) DEFAULT NULL,
    `referencia_comercial_direccion2` varchar(255) DEFAULT NULL,
    `referencia_bancaria_entidad` varchar(255) DEFAULT NULL,
    `referencia_bancaria_tipo` varchar(255) DEFAULT NULL,
    `referencia_bancaria_numero` varchar(55) DEFAULT NULL,
    `reconocimiento_publico` tinyint(1) DEFAULT NULL,
    `reconocimiento_publico_cual` varchar(255) DEFAULT NULL,
    `persona_expuesta` tinyint(1) DEFAULT NULL,
    `persona_expuesta_cual` varchar(255) DEFAULT NULL,
    `poder_publico` tinyint(1) DEFAULT NULL,
    `poder_publico_cual` varchar(255) DEFAULT NULL,
    `recursos_publicos` tinyint(1) DEFAULT NULL,
    `recursos_publicos_cual` varchar(255) DEFAULT NULL,
    `ingresos_mensuales` double DEFAULT NULL,
    `egresos_mensuales` double DEFAULT NULL,
    `activos` double DEFAULT NULL,
    `pasivos` double DEFAULT NULL,
    `otros_ingresos` double DEFAULT NULL,
    `concepto_otros_ingresos` varchar(255) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `solicitudes_credito_clientes` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `nombre` varchar(255) DEFAULT NULL,
    `identificacion_tipo_id` int(11) DEFAULT NULL,
    `documento_numero` varchar(55) DEFAULT NULL,
    `porcentaje_participacion` int(11) DEFAULT NULL,
    `solicitud_id` int(11) DEFAULT NULL,
    `formulario_tipo` int(11) DEFAULT NULL COMMENT '1: Socios o accionistas; 2: Beneficiarios finales de socios o accionistas iguales o superiores a 5%; 3: Personas autorizadas para brindar información',
    `celular` varchar(55) DEFAULT NULL,
    PRIMARY KEY (`id`),
    KEY `solicitud_id` (`solicitud_id`),
    CONSTRAINT `solicitudes_credito_clientes_ibfk_1` FOREIGN KEY (`solicitud_id`) REFERENCES `solicitudes_credito` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 20241003 SE cambian nombres de tablas anteriormente creadas
RENAME TABLE solicitudes_credito TO clientes_solicitudes_credito;
RENAME TABLE solicitudes_credito_clientes TO clientes_solicitudes_credito_detalle;

-- 20241008 Campo para diferenciar solicitudes nuevas o actualizaciones
ALTER TABLE `clientes_solicitudes_credito` ADD COLUMN `nueva` tinyint(1) NULL DEFAULT NULL AFTER `concepto_otros_ingresos`;

-- 20241016 Campos nuevos para la solicitud del crédito
ALTER TABLE `clientes_solicitudes_credito` ADD COLUMN `cantidad_vehiculos` int NULL DEFAULT 0 AFTER `nueva`;
ALTER TABLE `clientes_solicitudes_credito` ADD COLUMN `preferencia_enlace` tinyint(1) NULL COMMENT '1: Whatsapp; 2: Email' AFTER `cantidad_vehiculos`;

CREATE TABLE `api_tokens` (
    `id` INT(11) NOT NULL AUTO_INCREMENT,
    `user_id` INT(11) NOT NULL,
    `key` VARCHAR(40) NOT NULL,
    `level` INT(2) NOT NULL,
    `ignore_limits` TINYINT(1) NOT NULL DEFAULT '0',
    `is_private_key` TINYINT(1)  NOT NULL DEFAULT '0',
    `ip_addresses` TEXT NULL DEFAULT NULL,
    `date_created` INT(11) NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `api_logs` (
    `id` INT(11) NOT NULL AUTO_INCREMENT,
    `uri` VARCHAR(255) NOT NULL,
    `method` VARCHAR(6) NOT NULL,
    `params` TEXT DEFAULT NULL,
    `api_key` VARCHAR(40) NOT NULL,
    `ip_address` VARCHAR(45) NOT NULL,
    `time` INT(11) NOT NULL,
    `rtime` FLOAT DEFAULT NULL,
    `authorized` VARCHAR(1) NOT NULL,
    `response_code` smallint(3) DEFAULT '0',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 20250116 Se agrega nuevo campo en tabla de recibos
ALTER TABLE `recibos` ADD COLUMN `fecha_actualizacion_bot` datetime(0) NULL AFTER `numero_siesa`;

-- 20250125 Logs agregados
INSERT INTO `logs_tipos` (`id`, `nombre`) VALUES (55, 'Ingresa a contacto por Whatsapp')
INSERT INTO `logs_tipos` (`id`, `nombre`) VALUES (56, 'Otras transacciones de Wompi - Acceso al webhook')
INSERT INTO `logs_tipos` (`id`, `nombre`) VALUES (57, 'Webhook - Recibo de Wompi almacenado correctamente')

-- 20250125 Tipo de recibo agregado
INSERT INTO `recibos_tipos` (`id`, `nombre`) VALUES (4, 'Otras transacciones Wompi')

-- 20250126 Se agregan nuevos campos en las solicitudes de crédito
ALTER TABLE `clientes_solicitudes_credito` 
CHANGE COLUMN `nombre` `razon_social` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL AFTER `fecha_creacion`,
ADD COLUMN `nombre` varchar(100) NULL AFTER `fecha_creacion`,
ADD COLUMN `primer_apellido` varchar(55) NULL AFTER `nombre`,
ADD COLUMN `segundo_apellido` varchar(55) NULL AFTER `primer_apellido`;

ALTER TABLE `clientes_solicitudes_credito` 
ADD COLUMN `departamento_id` int NULL AFTER `documento_numero`,
ADD COLUMN `ciudad_id` int NULL AFTER `departamento_id`;

ALTER TABLE `clientes_solicitudes_credito` ADD COLUMN `fecha_expedicion` date NULL AFTER `fecha_creacion`;

ALTER TABLE `clientes_solicitudes_credito` ADD COLUMN `representante_legal_correo` varchar(255) NULL AFTER `representante_legal_documento_numero`;